---
title: "Biomass calibration from image analysis"
output: html_notebook
---

*2020-04-07 Lloren√ß Cabrera-Bosquet*

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 



**Packages**
```{r}
# Required packages
require(dplyr)
```
**Get data**
```{r}
# dataset containg measured biomass and the average values (mean of 12 side views) of variables
don <- read.csv("./calibrationBiomass.csv",h=T)

#  order by Biomass
don <- don %>% arrange(Biomass_measured) %>% 
  # create an index for selecting 1 row out of two
  mutate(ss=c(rep(1:2,nrow(don)/2)))
```

**Calibration and validation datasets**
```{r}
# create calibration and validation set
Calibset <- don %>%  filter(ss==1)
Validset <- don %>%  filter(ss==2)

```
**Linear Model fitting**
```{r}
# Fit the model Plant biomass vs imaging variables
fitBio <-lm(Calibset$Biomass_measured ~ Calibset$MeanPixelSide + Calibset$MeanAreaSide + Calibset$MeanHeight_overSide + Calibset$pixelsNb_top+ Calibset$area_CH_top -1)       

aBio = summary(fitBio)$coefficients[1, 1]
bBio = summary(fitBio)$coefficients[2, 1]
cBio = summary(fitBio)$coefficients[3, 1]
dBio = summary(fitBio)$coefficients[4, 1]
eBio = summary(fitBio)$coefficients[5, 1]

# summary of the model
summary(fitBio)

```
**Biomass estimation and RMSE**
```{r}
# Plant biomass g
Validset$Biomass_estimated <- (aBio*Validset$MeanPixelSide+ bBio*Validset$MeanAreaSide+ cBio*Validset$MeanHeight_overSide + dBio*Validset$pixelsNb_top + eBio*Validset$area_CH_top)
Validset$RMSE <-  (Validset$Biomass_estimated-Validset$Biomass_measured)^2
RMSE <-  sqrt(sum(na.omit(Validset$RMSE))/length(na.omit(Validset$RMSE)))

```
**Plot function**
```{r}
##Function Plot

yoyo <-function(x,y){
  plot(x,y, xlim=c(0,500), ylim=c(0,500), pch=21, col="blue", xlab="Measured Biomass (g FW) ", ylab= "Predicted Biomass (g FW)", cex.lab=1.3)
  #1:1 relationship
  abline(0,1, col="grey", lty="dashed",lwd=2)
  #Normal regression
  xy<-lm(y~x)
  #plot regression line
  abline(lm(xy))
  R2=summary(xy)$r.squared
  my.p = summary(xy)$coefficients[2,4]
  my.N = length(x)
  rp = vector('expression',2)
  rp= vector('expression',1)
  rp[1] = substitute(expression(italic(R)^2 == R2), list(R2 = format(R2,dig=3)))[2]
  rp[3] = substitute(expression(italic(n) == my.N), list(my.N = format(my.N, digits = 10)))[2]
  rp[2] = substitute(expression("RMSE" == RMSE), list(RMSE = format(RMSE, digits = 3)))[2]
  legend("topleft", c("1:1",rp[1],rp[2], rp[3]),lty = c("dashed","solid","solid","solid"), col = c("grey","black","white","white"),lwd = c(1,1,1,1), bty="n", cex=1)
}
```
**Plot results**
```{r}
yoyo(Validset$Biomass_measured,Validset$Biomass_estimated)
```


